// API URL dari Google Apps Script
const API_URL = "https://script.google.com/macros/s/AKfycbwsqoRcZSfotRknxPqOwoQyuM2fUzR38fskQlBz_6BHYEUyDPdf3UXygF-G7jE4iAi0/exec";

// Password admin
let adminPassword = "admin123";

// Fungsi untuk menampilkan notifikasi
function showNotification(message, type) {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = 'notification ' + type;
    notification.style.display = 'block';
    
    setTimeout(() => {
        notification.style.display = 'none';
    }, 3000);
}

// Fungsi untuk memuat buku dari Google Spreadsheet
async function loadBooks() {
    try {
        console.log("Loading books in admin...");
        const response = await fetch(`${API_URL}?action=getBooks`);
        console.log("Response status:", response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const books = await response.json();
        console.log("Books loaded in admin:", books);
        
        if (books.error) {
            throw new Error(books.error);
        }
        
        displayBooksInTable(books);
        return books;
    } catch (error) {
        console.error("Error loading books in admin:", error);
        showNotification("Gagal memuat data buku: " + error.message, "error");
        return [];
    }
}

// Fungsi untuk menampilkan buku di tabel
function displayBooksInTable(books) {
    const tableBody = document.getElementById('booksTableBody');
    tableBody.innerHTML = '';
    
    if (!books || books.length === 0) {
        tableBody.innerHTML = `
            <tr>
                <td colspan="5" style="text-align: center;">Tidak ada buku yang tersedia.</td>
            </tr>
        `;
        return;
    }
    
    books.forEach(book => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${book.id}</td>
            <td>${book.title}</td>
            <td>${book.author}</td>
            <td>${book.category}</td>
            <td>
                <button class="action-btn edit-btn" onclick="editBook('${book.id}')"><i class="fa fa-edit"></i></button>
                <button class="action-btn delete-btn" onclick="deleteBook('${book.id}')"><i class="fa fa-trash"></i></button>
            </td>
        `;
        tableBody.appendChild(row);
    });
}

// Fungsi untuk menambah buku
document.getElementById('addBookForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const title = document.getElementById('bookTitle').value;
    const author = document.getElementById('bookAuthor').value;
    const category = document.getElementById('bookCategory').value;
    const cover = document.getElementById('bookCover').value;
    const driveLink = document.getElementById('driveLink').value;
    
    console.log("Adding book:", { title, author, category, cover, driveLink });
    
    // Ekstrak file ID dari link Google Drive
    const drivePattern = /https:\/\/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/;
    const match = driveLink.match(drivePattern);
    
    if (!match) {
        showNotification('Format link Google Drive tidak valid!', 'error');
        return;
    }
    
    const fileId = match[1];
    
    // Generate cover URL jika tidak disediakan
    let coverUrl = cover;
    if (!coverUrl) {
        coverUrl = `https://via.placeholder.com/250x350?text=${encodeURIComponent(title)}`;
    }
    
    try {
        console.log("Sending request to add book...");
        const response = await fetch(`${API_URL}?action=addBook&id=${fileId}&title=${encodeURIComponent(title)}&author=${encodeURIComponent(author)}&category=${encodeURIComponent(category)}&cover=${encodeURIComponent(coverUrl)}`);
        console.log("Response status:", response.status);
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        console.log("Add book result:", result);
        
        if (result.success) {
            // Reset form
            this.reset();
            
            // Tampilkan notifikasi
            showNotification('Buku berhasil ditambahkan!', 'success');
            
            // Update tabel
            loadBooks();
        } else {
            showNotification('Gagal menambah buku: ' + (result.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        console.error("Error adding book:", error);
        showNotification('Gagal menambah buku: ' + error.message, 'error');
    }
});

// Fungsi untuk mengedit buku
async function editBook(id) {
    try {
        console.log("Editing book with ID:", id);
        // Load all books
        const response = await fetch(`${API_URL}?action=getBooks`);
        const books = await response.json();
        
        if (books.error) {
            throw new Error(books.error);
        }
        
        const book = books.find(b => b.id === id);
        if (!book) return;
        
        console.log("Book to edit:", book);
        
        // Isi form dengan data buku
        document.getElementById('bookTitle').value = book.title;
        document.getElementById('bookAuthor').value = book.author;
        document.getElementById('bookCategory').value = book.category;
        document.getElementById('bookCover').value = book.cover;
        document.getElementById('driveLink').value = `https://drive.google.com/file/d/${book.id}`;
        
        // Switch to add book tab
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        document.querySelector('.tab[data-tab="add-book"]').classList.add('active');
        
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById('add-book').classList.add('active');
        
        showNotification('Silakan edit data buku dan klik "Tambah Buku"', 'success');
    } catch (error) {
        console.error("Error editing book:", error);
        showNotification('Gagal memuat data buku: ' + error.message, 'error');
    }
}

// Fungsi untuk menghapus buku
async function deleteBook(id) {
    if (confirm('Apakah Anda yakin ingin menghapus buku ini?')) {
        try {
            console.log("Deleting book with ID:", id);
            const response = await fetch(`${API_URL}?action=deleteBook&id=${id}`);
            console.log("Response status:", response.status);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const result = await response.json();
            console.log("Delete book result:", result);
            
            if (result.success) {
                showNotification('Buku berhasil dihapus!', 'success');
                loadBooks();
            } else {
                showNotification('Gagal menghapus buku: ' + (result.error || 'Unknown error'), 'error');
            }
        } catch (error) {
            console.error("Error deleting book:", error);
            showNotification('Gagal menghapus buku: ' + error.message, 'error');
        }
    }
}

// Fungsi untuk menyimpan pengaturan
document.getElementById('settingsForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const newPassword = document.getElementById('adminPassword').value;
    if (newPassword) {
        adminPassword = newPassword;
    }
    
    showNotification('Pengaturan berhasil disimpan!', 'success');
});

// Tab navigation
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', function() {
        const tabId = this.getAttribute('data-tab');
        
        // Update active tab
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        this.classList.add('active');
        
        // Update active content
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        
        // Load books table if manage books tab is active
        if (tabId === 'manage-books') {
            loadBooks();
        }
    });
});

// Cek password admin
window.addEventListener('load', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const auth = urlParams.get('auth');
    
    if (auth !== 'admin123') {
        const password = prompt('Masukkan password admin:');
        if (password !== adminPassword) {
            alert('Password salah!');
            window.location.href = 'index.html';
        }
    }
});
